/*! leaflet-datatracker - v0.1.1 - 2025-11-15 */
!function(t){var o;"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):((o="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).L||(o.L={})).DataTracker=t()}(function(){return function i(e,n,s){function a(o,t){if(!n[o]){if(!e[o]){var r="function"==typeof require&&require;if(!t&&r)return r(o,!0);if(u)return u(o,!0);throw(t=new Error("Cannot find module '"+o+"'")).code="MODULE_NOT_FOUND",t}r=n[o]={exports:{}},e[o][0].call(r.exports,function(t){return a(e[o][1][t]||t)},r,r.exports,i,e,n,s)}return n[o].exports}for(var u="function"==typeof require&&require,t=0;t<s.length;t++)a(s[t]);return a}({1:[function(t,o,r){L.DataTracker=L.GeoJSON.extend({options:{url:null,frequency:5e3,itemExtractor:function(t){return t.data||t},itemFilter:function(t){return!0},idExtractor:function(t){return t.id},metadataExtractor:function(t){return{lon:t.lon||t.longitude,lat:t.lat||t.latitude}},lonExtractor:function(t){return t.lon},latExtractor:function(t){return t.lat},minPositions:2,maxHistorySize:10,style:{color:"#3388ff",weight:3,opacity:.7},styleFunction:null,onUpdate:null,onError:null,autoStart:!0},initialize:function(t){if(L.setOptions(this,t),!this.options.url)throw new Error("DataTracker requires a url option");this._history={},this._intervalId=null,L.GeoJSON.prototype.initialize.call(this,null,{style:t=>this.options.styleFunction?this.options.styleFunction(t):this.options.style,onEachFeature:this.options.onEachFeature}),this.options.autoStart&&this.start()},start:function(){return this._intervalId||(this._fetchAndUpdate(),this._intervalId=setInterval(()=>{this._fetchAndUpdate()},this.options.frequency)),this},stop:function(){return this._intervalId&&(clearInterval(this._intervalId),this._intervalId=null),this},clearHistory:function(){return this._history={},this.clearLayers(),this},getHistory:function(){return this._history},_fetchAndUpdate:function(){fetch(this.options.url).then(t=>{if(t.ok)return t.json();throw new Error("HTTP error! status: "+t.status)}).then(t=>{this._processData(t)}).catch(t=>{console.error("DataTracker fetch error:",t),this.options.onError&&this.options.onError(t)})},_processData:function(t){t=this.options.itemExtractor(t);if(Array.isArray(t)){let r={};t.forEach(t=>{var o=this.options.idExtractor(t),t=this.options.metadataExtractor(t);null!=o&&t&&(r[o]||(r[o]=[]),r[o].push(t))}),this._mergeHistory(r),this._updateGeoJSON(),this.options.onUpdate&&this.options.onUpdate(this._history)}else console.error("itemExtractor must return an array")},_mergeHistory:function(r){Object.keys(r).forEach(t=>{this._history[t]||(this._history[t]=[]);var o=this._history[t].concat(r[t]),o=this._deduplicatePositions(o);this.options.maxHistorySize&&0<this.options.maxHistorySize?this._history[t]=o.slice(-this.options.maxHistorySize):this._history[t]=o})},_deduplicatePositions:function(t){let r=[],i=new Set;return t.forEach(t=>{var o=this.options.lonExtractor(t)+","+this.options.latExtractor(t);i.has(o)||(i.add(o),r.push(t))}),r},_filterMovedTracks:function(){let r={};return Object.keys(this._history).forEach(t=>{var o=this._history[t];o.length>=this.options.minPositions&&(r[t]=o)}),r},_buildGeoJSON:function(){let i=this._filterMovedTracks();return{type:"FeatureCollection",features:Object.keys(i).map(t=>{var o=i[t],r=o.map(t=>[this.options.lonExtractor(t),this.options.latExtractor(t)]);return{type:"Feature",properties:{id:t,pointCount:o.length},geometry:{type:"LineString",coordinates:r}}})}},_updateGeoJSON:function(){var t=this._buildGeoJSON();this.clearLayers(),this.addData(t)},onAdd:function(t){return L.GeoJSON.prototype.onAdd.call(this,t),this.options.autoStart&&!this._intervalId&&this.start(),this},onRemove:function(t){return this.stop(),L.GeoJSON.prototype.onRemove.call(this,t),this}}),L.dataTracker=function(t){return new L.DataTracker(t)},o.exports=L.DataTracker},{}]},{},[1])(1)});